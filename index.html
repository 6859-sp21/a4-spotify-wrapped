<!DOCTYPE html>
<meta charset="utf-8" />
<script src="https://d3js.org/d3.v6.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.7.1/d3-tip.min.js"></script>
<!-- Boostrap -->
<link
  rel="stylesheet"
  href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

<html>
  <style>
    body,
    p {
      font: 15px helvetica;
    }

    #chart {
      background: white;
    }

    .circularBar {
      /* fill: mediumaquamarine; */
    }

    .circularBar:hover {
      /* fill: darkgreen; */
    }

    .circularBarTip {
      line-height: 1;
      font-weight: bold;
      padding: 12px;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      border-radius: 2px;
    }

    /* Creates a small triangle extender for the tooltip */
    .circularBarTip:after {
      box-sizing: border-box;
      display: inline;
      font-size: 10px;
      width: 100%;
      line-height: 1;
      color: rgba(0, 0, 0, 0.8);
      content: "\25BC";
      position: absolute;
      text-align: center;
    }

    /* Style northward tooltips differently */
    .dcircularBarTip.n:after {
      margin: -1px 0 0 0;
      top: 100%;
      left: 0;
    }

    div.barTooltip {
      position: absolute;
      text-align: center;
      width: 200px;
      height: 100px;
      padding: 2px;
      font: 12px sans-serif;
      background: lightsteelblue;
      border: 0px;
      border-radius: 8px;
      pointer-events: none;
    }

    div.tooltip {
  position: absolute;
  text-align: center;
  width: 200px;
  height: 50px;
  padding: 2px;
  font: 12px sans-serif;
  background: white;
  border: 0px;
  border-radius: 8px;
  pointer-events: none;
}
  </style>
  <head>
    <title>Spotify Wrapped</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <style>
      /* Remove the navbar's default rounded borders and increase the bottom margin */
      .navbar {
        flex-wrap: initial;
        justify-content: left;
      }

      .navbar {
        margin-bottom: 50px;
        /* border-radius: 0; */
      }

      /* Remove the jumbotron's default bottom margin */
      .jumbotron {
        margin-bottom: 0;
      }

      /* Add a gray background color and some padding to the footer */
      footer {
        background-color: #f2f2f2;
        padding: 25px;
      }
    </style>
  </head>
  <body>
    <div class="jumbotron">
      <div class="container text-center">
        <h2>Remember your favorite hit song?</h2>
        <p>Or...was it even a hit at all? Play below to find out!</p>
      </div>
    </div>

      <div class="container">
        <div class="row">
          <div class="col-sm-8">
            <h3>Current song: <span id="song-title"></span></h3>
            <p>
              <i>Guess if the song was a hit or flop based on the data below.</i>
            </p>
          </div>
          <div class = "col-sm-4" style = "padding: 10px;">
            <h4>
              Your Guess:
              <button
                type="button"
                id="hit"
                class="btn btn-success"
                onClick="isHit(true)"
                style ="width: 100px; height: 50px"
              >
                Hit
              </button>
              <button
                type="button"
                id="flop"
                class="btn btn-danger"
                onClick="isHit(false)"
                style ="width: 100px; height: 50px"
              >
                Flop
              </button>
            </h4>
          </div>
        </div>

        <div class="row">
          <div class="col-sm-12">
            <!-- <h4>
              Your Guess:
              <button
                type="button"
                id="hit"
                class="btn btn-success"
                onClick="isHit(true)"
              >
                Hit
              </button>
              <button
                type="button"
                id="flop"
                class="btn btn-danger"
                onClick="isHit(false)"
              >
                Flop
              </button>
            </h4> -->
            <div id="result"></div>
            <button
              type="button"
              id="next"
              class="btn btn-primary"
              style="margin-bottom: 5px"
            >
              Next Song
            </button>
    
            <br /><br />
            <!-- <form class="form-inline" style = "color: white;">Search for a song:
          <input type="email" class="form-control" size="50" placeholder="Song Name">
          <button type="button" class="btn btn-danger">Search</button>
        </form> -->
          </div>
          </div>
        </div>
        <!-- <div id="song-search-box" class='input-group input-group-lg'>
      <input type="text" id="song-search" >
    </div> -->
<br>
    <div class="container">
      <div class="row">
        <div class="col-sm-6" style = "text-align: center">
          <h4 id = "radialTitle">Test Title</h4>
        </div>
        <div class="col-sm-6" style = "text-align: center">
          <h4 id = "scatterTitle">Test Title #2</h4>
          </div>
        </div>
        <hr>
      <div class="row">
        <div class="col-sm-6">
          <div id="circularBarplot"></div>
        </div>
        <div class="col-sm-6">
              <select id="selectButton"></select>
              <div style="text-align:center" id="scatterPlot"></div>
          </div>
        </div>
      </div>
    </div>
    <br />

    <br /><br />

    <footer class="container-fluid text-center">
      <div class = "row">
        <div class = "col-sm-12">
          <h4>Checkout our references!</h4>
        </div>
      </div>

      <div class = "row">
        <div class = "col-sm-4">
          <a href="https://www.kaggle.com/yamaerenay/spotify-dataset-19212020-160k-tracks">Dataset</a>
        </div>
        <div class = "col-sm-4">
          <a href="https://www.d3-graph-gallery.com/graph/line_select.html">Dropdown Template</a>
        </div>
        <div class = "col-sm-4">
          <a href="https://github.com/d3/d3-scale-chromatic/blob/master/README.md">Color Scheme</a>
        </div>
      </div>
      

    </footer>
  </body>

  <script src="js/hit_flop.js"></script>
  <script>
    const FEATURES_OF_INTEREST = [
      "acousticness",
      "danceability",
      "energy",
      "instrumentalness",
      "liveness",
      "speechiness",
      "valence",
    ];

    const FEATURE_DEFINITIONS = {
      'acousticness': 'A confidence measure between 0 and 1 of whether the track is acoustic.',
      'danceability': 'How suitable a track is for dancing based on various musical elements.',
      'energy': 'A perceptual measure of intensity and activity. Energetic tracks are typically fast and loud.',
      'instrumentalness': 'Whether a track contains no vocals.',
      'liveness': 'Likelihood that the track was performed live through detecting whether there was audience presence in the recording.',
      'speechiness': 'The level of speech-like elements (e.g. talk show, audio book, poetry) in the recording.',
      'valence': 'A measure from 0 to 1 describing the musical positiveness (e.g. happy, cheerful, euphoric) conveyed by a track.'
    }

    const MARGIN = { top: 40, right: 10, bottom: 50, left: 0 },
      width = 460 - MARGIN.left - MARGIN.right,
      height = 460 - MARGIN.top - MARGIN.bottom,
      innerRadius = 90,
      outerRadius = Math.min(width, height) / 2;

      var artist_list = [];

      var myColor = d3.scaleOrdinal().domain(FEATURES_OF_INTEREST).range(d3.schemeSet3);

    d3.csv("merged_datasets.csv", d3.autoType)
      .then(function (data) {
        var song = getRandomSong(data);
        var nextSongElement = document.getElementById("next");
        nextSongElement.addEventListener("click", () => {
          song = getRandomSong(data);
          document.getElementById("radialTitle").innerHTML = "Audio Features of song: " + song.name
          document.getElementById("scatterTitle").innerHTML = "Reference Songs for " + song.artist
          updateScatter(song);
          updateCircularBarplot(song);
        });
        console.log(data);
        document.getElementById("radialTitle").innerHTML = "Audio Features of song: " + song.name
        document.getElementById("scatterTitle").innerHTML = "Reference Songs for " + song.artist

        // var song = getRandomSong(data)
        console.log(song);

        // makeCircularBarplot(song)

        songTitles = data.map((d) => d.name);
        console.log(songTitles);

        // Make circular barplot
        var transformedData = transformSongFeatureData(
          song,
          FEATURES_OF_INTEREST
        );
        console.log(transformedData);

        // append the svg object
        var svg = d3
          .select("#circularBarplot")
          .append("svg")
          .attr("width", width + MARGIN.left + MARGIN.right)
          .attr("height", height + MARGIN.top + MARGIN.bottom)
          .append("g")
          .attr(
            "transform",
            "translate(" +
              (width / 2 + MARGIN.left) +
              "," +
              (height / 2 + MARGIN.top) +
              ")"
          );

        // Add chart title to bar plot
        svg
          .append("text")
          .attr("x", 0)
          .attr("y", (0 - MARGIN.top) * 2)
          .attr("text-anchor", "middle")
          .style("font-size", "16px");
          // .text(`Audio Features of ${song.name}`);

        // Scales
        var xBar = d3
          .scaleBand()
          .range([0, 2 * Math.PI]) // X axis goes from 0 to 2pi = all around the circle. If I stop at 1Pi, it will be around a half circle
          .align(0) // This does nothing
          .domain(
            transformedData.map(function (d) {
              return d.feature;
            })
          ); // The domain of the X axis is the list of states.
        var yBar = d3
          .scaleRadial()
          .range([innerRadius, outerRadius]) // Domain will be define later.
          .domain([0, 1]); // Domain of Y is from 0 to the max seen in the data

                  //Add tooltip
        var tooltipCircle = d3.select("#circularBarplot")
            .append("div")
            .style("opacity", 0)
            .attr("class", "barTooltip")
            .style("background-color", "white")
            .style("border", "solid")
            .style("border-width", "1px")
            .style("border-radius", "5px")
            .style("padding", "10px")

            var mouseover = function(d) {
              tooltipCircle
              .style("opacity", 1)
              d3.select(this)
              .style("stroke", "black")
              .style("opacity", 1)
              }

  var mousemove = function(d) {
    // console.log(d3.pointer(event)[0])
    // console.log(d3.pointer(event)[1])
    // console.log(d)
    var currentFeature = d.srcElement.__data__.feature
    tooltipCircle
      .html(`<strong>${currentFeature}</strong>: ${FEATURE_DEFINITIONS[currentFeature]} <br><strong>Feature value</strong>: <span style='color:red;'>${d.srcElement.__data__.value}</span>`)
      // .style("left", d3.select(this).attr("cx") + "px")     
      // .style("top", d3.select(this).attr("cy") + "px");
      // .style("left", (d3.pointer(event)[1] - 100) + "px")     
      // .style("top", (d3.pointer(event)[0] - 100) + "px");
      .style("left", (d.clientX - d.layerX + d.movementX) + "px")
      .style("top", (d.clientY - d.layerY + d.movementY) + "px")
      // .style("left", (d.movementX) + "px")
      // .style("top", (d.movementY) + "px")
      // .style("left")
      // .style("top")
  }
  var mouseleave = function(d) {
    tooltipCircle
      .transition()
      .duration(150)
      .style("opacity", 0)
      d3.select(this)
      .style("stroke", "none")
      .style("opacity", 0.8)
  }

        // Add the bars
        var bars = svg
          .append("g")
          .selectAll("path")
          .data(transformedData)
          .enter()
          .append("path")
          .attr("fill", function(d){return myColor(d.feature) })
          .attr("class", "circularBar")
          .attr(
            "d",
            d3
              .arc() // imagine your doing a part of a donut plot
              .innerRadius(innerRadius)
              .outerRadius(function (d) {
                return yBar(d["value"]);
              })
              .startAngle(function (d) {
                return xBar(d.feature);
              })
              .endAngle(function (d) {
                return xBar(d.feature) + xBar.bandwidth();
              })
              .padAngle(0.01)
              .padRadius(innerRadius)
          )
          .on("mouseover", mouseover )
          .on("mousemove", mousemove )
          .on("mouseleave", mouseleave );

        // Add the labels
        svg
          .append("g")
          .selectAll("g")
          .data(transformedData)
          .enter()
          .append("g")
          .attr("text-anchor", function (d) {
            return (xBar(d.feature) + xBar.bandwidth() / 2 + Math.PI) %
              (2 * Math.PI) <
              Math.PI
              ? "end"
              : "start";
          })
          .attr("transform", function (d) {
            return (
              "rotate(" +
              (((xBar(d.feature) + xBar.bandwidth() / 2) * 180) / Math.PI -
                90) +
              ")" +
              "translate(" +
              (yBar(d["value"]) + 10) +
              ",0)"
            );
          })
          .append("text")
          .text(function (d) {
            return d.feature;
          })
          .attr("transform", function (d) {
            return (xBar(d.feature) + xBar.bandwidth() / 2 + Math.PI) %
              (2 * Math.PI) <
              Math.PI
              ? "rotate(180)"
              : "rotate(0)";
          })
          .style("font-size", "11px")
          .attr("alignment-baseline", "middle");

        function updateCircularBarplot(newSong) {
          console.log("in update circular barplot, new song is");
          console.log(newSong);
          let updatedData = transformSongFeatureData(
            newSong,
            FEATURES_OF_INTEREST
          );
          console.log(updatedData);

          bars
            .data(updatedData)
            .transition()
            .duration(1000)
            .attr(
              "d",
              d3
                .arc() // imagine you're doing a part of a donut plot
                .innerRadius(innerRadius)
                .outerRadius(function (d) {
                  return yBar(d["value"]);
                })
                .startAngle(function (d) {
                  return xBar(d.feature);
                })
                .endAngle(function (d) {
                  return xBar(d.feature) + xBar.bandwidth();
                })
                .padAngle(0.01)
                .padRadius(innerRadius)
            );

          svg
            .append("g")
            .selectAll("g")
            .data(transformedData)
            .transition()
            .duration(1000);
        }
        //******************************************************ARTIST SCATTER PLOT*******************************************
        artist_list = data.filter(function (s) {
          return s.artist == song.artist;
        });
        console.log('artist_list')
        console.log(artist_list)

        d3.select("#selectButton")
          .selectAll("myOptions")
          .data(FEATURES_OF_INTEREST)
          .enter()
          .append("option")
          .text(function (d) {
            return d;
          }) // text showed in the menu
          .attr("value", function (d) {
            return d;
          });

        var svgScatter = d3
          .select("#scatterPlot")
          .append("svg")
          .attr("width", width + MARGIN.left + MARGIN.right)
          .attr("height", height + MARGIN.top + MARGIN.bottom)
          .append("g")
          // .style('transform', 'translate(5%, 5%)')
          .attr(
            "transform",
            "translate(" +
            MARGIN.left + 34 +
              "," +
              MARGIN.top +
              ")"
          );

          // Add chart title to scatter plot
           svgScatter
            .append("text")
            .attr("class", "scatterTitle")
            .attr("x", width + 50)
            .attr("y", (0 - MARGIN.top)*.5)
            .attr("text-anchor", "middle")
            .style("font-size", "16px")

          // Create x axis label
          svgScatter
            .append('text')
            .attr('x', width/2 - MARGIN.right)
            .attr('y', MARGIN.top * 1.5 + height/2 + 170)
            .style('text-anchor', 'middle')
            .text('Year')

          // Create y axis label
          svgScatter
            .append('text')
            .attr('y', -25)
            .attr('x', -height / 2)
            .style('text-anchor', 'middle')
            .attr('transform', 'rotate(-90)')
            .text('Value')

        var x = d3
          .scaleLinear()
          .domain(
            d3.extent(data, function (d) {
              return d.year;
            })
          )
          .range([MARGIN.left, width - MARGIN.right]);

        svgScatter
          .append("g")
          .attr("transform", `translate(0, ${height})`)
          .call(d3.axisBottom(x))
          // .attr("opacity", "0");

        // Add Y axis
        var y = d3.scaleLinear().domain([0, 1]).range([height, 0]);
        svgScatter.append("g").call(d3.axisLeft(y));


        var tooltip = d3.select("#scatterPlot")
            .append("div")
            .style("opacity", 0)
            .attr("class", "tooltip")
            // .style("background-color", "white")
            // .style("border", "solid")
            // .style("border-width", "1px")
            // .style("border-radius", "5px")
            // .style("padding", "10px")

            var mouseoverScatter = function(d) {
              tooltip
              .style("opacity", 1)
              d3.select(this)
              .style("stroke", "black")
              .style("opacity", 1)
              .style('display', 'block')
              }

  var mousemoveScatter = function(d) {
    tooltip
      .html('Artist: ' + d.srcElement.__data__.artist + "<br>" + 'Song: ' + d.srcElement.__data__.name)
      .style("left", (d.offsetX) + "px")
      .style("top", (d.offsetY) + "px")
      .style('display', 'block');
  }
  var mouseleaveScatter = function(d) {
    tooltip
      .transition()
      .duration(200)
      .style("opacity", 0)
      d3.select(this)
              .style("stroke", "black")
              .style("opacity", 1)
              .style('display', 'block')
  }

  // var shape = d3.scaleOrdinal(artist_list.map(d => d.mode), d3.symbols.map(s => d3.symbol().type(s)()))
  // var symbol = d3.symbol();

        // Add dots
        var dot = svgScatter
          .append("g")
          .selectAll("dot")
          .data(artist_list)
          .enter()
          .append("circle")
          .attr("cx", function (d) {
            return x(d.year);
          })
          .attr("cy", function (d) {
            return y(d.acousticness);
          })
          .attr("r", 10)
          // .style("fill", "#69b3a2")
    //       .on("mouseover", function(event,d) {
    //    tooltip.transition()
    //      .duration(200)
    //      .style("opacity", .9);
    //    tooltip.html(d.artist + "<br/>" + d.name)
    //     //  .style("left", (event.pageX) + "px")
    //     //  .style("top", (event.pageY) + "px");
    //    })
    //  .on("mouseout", function(d) {
    //    tooltip.transition()
    //      .duration(500)
    //      .style("opacity", 0);
    //    })
          .on("mouseover", mouseoverScatter )
          .on("mousemove", mousemoveScatter )
          .on("mouseleave", mouseleaveScatter )
          .attr("fill", function(d){return myColor("acousticness") })
          // .attr("d", symbol.type(function(d){
    // if(d.name == song.name){ console.log(d.name + " " + song.name); return d3.symbolCross
    // } else if (d.name == "Bournville"){ return d3.symbolDiamond
    // } else if (d.name == "Dolfin"){ return d3.symbolSquare
    // } else if (d.name == "Hershey"){ return d3.symbolStar
    // } else if (d.name == "Galaxy"){ return d3.symbolTriangle
    // } else if (d.name == "Dairy Milk"){ return d3.symbolCircle
// }}))
          // .attr("d", function(d) {console.log(d.mode); return shape(d.mode)});


        // new X axis
        x.domain(
          d3.extent(data, function (d) {
            return d.year;
          })
        );

        svgScatter
          .select(".myXaxis")
          .transition()
          .duration(2000)
          .attr("opacity", "1")
          .call(d3.axisBottom(x))

  // A function that change this tooltip when the leaves a point: just need to set opacity to 0 again

        // When the button is changed, run the updateChart function
        d3.select("#selectButton").on("change", function (d) {
          var selectedOption = d3.select(this).property("value");

          updateScatterField(selectedOption);
        });

        function updateScatterField(selectedOption) {
          console.log(selectedOption)
          console.log(artist_list)

            svgScatter
            .selectAll('circle')
            .data(artist_list)
            .join(
              update => update
            )
            .transition()
            .duration(2000)
            .attr("cx", function (d) {
              return x(d.year);
            })
            .attr("cy", function (d) {
              return y(d[selectedOption]);
            })
            .attr("r", 10)
            .attr("fill", function(d){return myColor(selectedOption) })
        }

        function updateScatter(song) {
          svgScatter.selectAll('circle').remove();

          artist_list = data.filter(function (s) {
            return s.artist == song.artist;
          });

          console.log('artist_list')
          console.log(artist_list)

          currentSelection = $("#selectButton option:selected");

          svgScatter
            .selectAll('dot')
            .data(artist_list)
            .join(
              enter => enter.append('circle')
            )
            .transition()
            .duration(2000)
            .attr("cx", function (d) {
              return x(d.year);
            })
            .attr("cy", function (d) {
              return y(d[currentSelection[0].innerHTML]);
            })
            .attr("r", 10)
            .attr("fill", function(d){return myColor(currentSelection[0].innerHTML) })

            updateScatterField(currentSelection[0].innerHTML)
        }
        //******************************************************END ARTIST SCATTER PLOT*******************************************
      })
      .catch((e) => {
        console.log(e);
      });

    function transformSongFeatureData(song, featuresOfInterest) {
      var output = [];
      featuresOfInterest.forEach((feature) => {
        var dict = { feature: [feature][0], value: [song[feature]][0] };
        output.push(dict);
      });
      return output;
    }
  </script>
</html>
